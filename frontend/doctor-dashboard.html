<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Dashboard - CareLink AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
</head>

<body class="h-full bg-slate-50">
    <div id="app" class="h-full flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-md">
                        <span class="text-xl">üë®‚Äç‚öïÔ∏è</span>
                    </div>
                    <div>
                        <h1 class="font-bold text-gray-800 text-lg">Doctor Dashboard</h1>
                        <p class="text-xs text-slate-500" id="doctor-welcome">Loading...</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="logout()"
                        class="flex items-center gap-2 px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition text-sm font-medium">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                            </path>
                        </svg>
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 w-full max-w-7xl mx-auto px-4 py-8 overflow-y-auto">

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 fade-in">
                <!-- Total Patients -->
                <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-100">
                    <p class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-1">Total Patients</p>
                    <div class="flex items-end justify-between">
                        <p class="text-3xl font-bold text-slate-800" id="total-patients">-</p>
                        <div class="text-blue-500 bg-blue-50 p-2 rounded-lg">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0z">
                                </path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- High Risk -->
                <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-100">
                    <p class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-1">High Risk</p>
                    <div class="flex items-end justify-between">
                        <p class="text-3xl font-bold text-red-500" id="high-risk-count">-</p>
                        <div class="text-red-500 bg-red-50 p-2 rounded-lg">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                                </path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Active Alerts -->
                <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-100">
                    <p class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-1">Active Alerts</p>
                    <div class="flex items-end justify-between">
                        <p class="text-3xl font-bold text-amber-500" id="alert-count">-</p>
                        <div class="text-amber-500 bg-amber-50 p-2 rounded-lg">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                                </path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Avg Heart Rate -->
                <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-100">
                    <p class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-1">Avg Heart Rate</p>
                    <div class="flex items-end justify-between">
                        <p class="text-3xl font-bold text-emerald-500" id="avg-hr">-</p>
                        <div class="text-emerald-500 bg-emerald-50 p-2 rounded-lg">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z">
                                </path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alerts Banner -->
            <div id="alerts-banner" class="hidden mb-8 space-y-3">
                <!-- Alerts injected here -->
            </div>

            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-slate-800">Assigned Patients</h2>
                <div class="flex gap-2">
                    <span
                        class="bg-white px-3 py-1 rounded-lg border border-slate-200 text-xs font-semibold text-slate-500 flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-green-500"></span> Live Monitoring
                    </span>
                </div>
            </div>

            <!-- Patient Grid -->
            <div id="patient-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Patients injected here -->
            </div>

        </main>
    </div>

    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="flex flex-col items-center">
            <div class="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
            <p class="text-slate-500 font-medium animate-pulse">Connecting to CareLink Network...</p>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api';
        let token = localStorage.getItem('access_token');
        let user = JSON.parse(localStorage.getItem('user') || '{}');

        // Authentication Check
        if (!token || user.role !== 'doctor') {
            window.location.href = '/index.html';
        }

        // Initialize user info
        document.getElementById('doctor-welcome').textContent = `Dr. ${user.first_name} ${user.last_name}`;

        async function fetchDashboardData() {
            try {
                const response = await fetch(`${API_URL}/doctor/patients`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.status === 401) logout();

                const patients = await response.json();
                updateDashboard(patients);
                fetchAlerts();
            } catch (error) {
                console.error('Data fetch error:', error);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        async function fetchAlerts() {
            try {
                const response = await fetch(`${API_URL}/doctor/alerts`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const alerts = await response.json();
                renderAlerts(alerts);
                document.getElementById('alert-count').textContent = alerts.length;
            } catch (e) { console.error(e); }
        }

        function updateDashboard(patients) {
            // Stats
            document.getElementById('total-patients').textContent = patients.length;
            document.getElementById('high-risk-count').textContent = patients.filter(p => p.risk === 1).length;

            // Calc Avg HR
            const validHRs = patients.filter(p => p.heart_rate).map(p => p.heart_rate);
            const avgHR = validHRs.length ? Math.round(validHRs.reduce((a, b) => a + b) / validHRs.length) : '-';
            document.getElementById('avg-hr').textContent = avgHR + ' bpm';

            // Render Grid
            const container = document.getElementById('patient-grid');

            if (patients.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-10 text-slate-500">No patients assigned.</div>`;
                return;
            }

            container.innerHTML = patients.map((p, index) => {
                const riskColor = p.risk === 1 ? 'red' : 'emerald';
                const trendIcon = p.trend === 'DETERIORATING'
                    ? `<span class="text-red-500">‚Üò Deteriorating</span>`
                    : p.trend === 'RECOVERING'
                        ? `<span class="text-emerald-500">‚Üó Recovering</span>`
                        : `<span class="text-slate-400">‚Üí Stable</span>`;

                return `
                <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-100 card-hover fade-in" style="animation-delay: ${index * 0.05}s">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-lg font-bold text-slate-600">
                                ${p.first_name[0]}${p.last_name[0]}
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800">${p.first_name} ${p.last_name}</h3>
                                <p class="text-xs text-slate-500">${p.age} yrs ‚Ä¢ ID: #${p.id}</p>
                            </div>
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs font-bold ${p.risk === 1 ? 'bg-red-100 text-red-600' : 'bg-emerald-100 text-emerald-600'}">
                            ${p.risk === 1 ? 'High Risk' : 'Normal'}
                        </span>
                    </div>

                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <div class="bg-slate-50 rounded-lg p-2 text-center">
                            <p class="text-[10px] text-slate-400 uppercase font-bold">Heart Rate</p>
                            <p class="text-lg font-bold text-slate-700">${p.heart_rate}</p>
                        </div>
                        <div class="bg-slate-50 rounded-lg p-2 text-center">
                            <p class="text-[10px] text-slate-400 uppercase font-bold">SpO2</p>
                            <p class="text-lg font-bold text-slate-700">${p.spo2}%</p>
                        </div>
                        <div class="bg-slate-50 rounded-lg p-2 text-center">
                            <p class="text-[10px] text-slate-400 uppercase font-bold">Temp</p>
                            <p class="text-lg font-bold text-slate-700">${p.temperature}¬∞</p>
                        </div>
                    </div>

                    <div class="flex justify-between items-center text-xs border-t border-slate-50 pt-3">
                        ${trendIcon}
                        <button class="text-blue-500 font-semibold hover:underline">View Details</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        function renderAlerts(alerts) {
            const banner = document.getElementById('alerts-banner');
            if (alerts.length === 0) {
                banner.innerHTML = '';
                banner.classList.add('hidden');
                return;
            }

            banner.classList.remove('hidden');
            banner.innerHTML = alerts.slice(0, 3).map(alert => `
                <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg flex justify-between items-center shadow-sm slide-up">
                    <div class="flex items-center gap-3">
                        <div class="bg-red-500 text-white rounded-full p-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        </div>
                        <div>
                            <p class="text-sm font-bold text-red-800">${alert.type ? alert.type.replace('_', ' ').toUpperCase() : 'ALERT'}</p>
                            <p class="text-xs text-red-600">${alert.message}</p>
                        </div>
                    </div>
                    <button onclick="acknowledgeAlert(${alert.id})" class="text-xs bg-white border border-red-200 text-red-600 px-3 py-1 rounded hover:bg-red-50 transition">
                        Dismiss
                    </button>
                </div>
            `).join('');
        }

        async function acknowledgeAlert(id) {
            await fetch(`${API_URL}/staff/alert/${id}/acknowledge`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            fetchAlerts(); // Refresh
        }

        function logout() {
            localStorage.clear();
            window.location.href = '/index.html';
        }

        // Initialize
        fetchDashboardData();
        setInterval(fetchDashboardData, 3000); // 3s polling
    </script>
</body>

</html>